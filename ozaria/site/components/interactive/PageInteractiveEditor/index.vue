<script>
import { getInteractive, putInteractive, postInteractive, getAllInteractives } from '../../../api/interactive'
import Interactive from '../../../models/Interactive'
import ListItem from '../../common/BaseListItem'
import Ajv from 'ajv'
import ozariaUtils from 'app/core/ozariaUtils'

require('lib/setupTreema')

module.exports = Vue.extend({
  props: {
    slug: String
  },
  data: () => ({
    interactive: null,
    treema: null,
    interactiveList: null,
    valid: true,
    state: {
      saving: false
    },
    interactiveSlug: ""
  }),
  components: {
    'list-item': ListItem
  },
  async created () {
    if (!me.hasInteractiveAccess()) {
      alert('You must be logged in as an admin to use this page.')
      return application.router.navigate('/editor', { trigger: true })
    }
    console.log(`Got the slug: ${this.slug}`)
    this.interactiveSlug = this.slug
    if (this.interactiveSlug)  {
      await this.fetchInteractive(this.interactiveSlug)
    }
    else {
      await this.fetchList()
    }
  },
  methods: {
    /**
     * Fetch and populate treema with interactive slug.
     * Clears the list
     */
    async fetchInteractive(slug) {
      this.interactiveList = null
      this.interactiveSlug = slug
      try {
        this.interactive = new Interactive(await getInteractive(slug))
      } catch (e) {
        noty({ text: `Error finding slug '${slug}'.`, type: 'error', timeout: '1000' })
        return this.fetchList()
      }
      const data = $.extend(true, {}, this.interactive.attributes)
      const el = $(`<div></div>`);
      const treemaOptions = {
        data: data,
        schema: Interactive.schema,
        callbacks: {
          change: this.onTreemaChanged
        }
      }
      const treema = this.treema = TreemaNode.make(el, treemaOptions)
      treema.build()
      $(this.$refs.treemaEditor).append(el)
    },

    /**
     * Fetch all names and slugs of interactives from the database.
     * Clears the slug and treema.
     */
    async fetchList () {
      this.interactive = null
      this.interactiveSlug = ''
      this.treema = null
      $(this.$refs.treemaEditor).children().remove()
      try {
        this.interactiveList = await getAllInteractives();
      } catch (e) {
        console.error("Error while fetching the interactive list:", e)
        noty({ text: 'Error occured while fetching the interactive list', type: 'error', timeout: 1000 })
      }
    },

    /**
     * Performs schema validation and pushes changes from treema to the interactive model.
     */
    onTreemaChanged() {
      const ajv = new Ajv(ozariaUtils.getAjvOptions())
      const data = this.treema.data
      this.valid = ajv.validate(Interactive.schema, data)
      if (this.valid) {
        this.interactive.set(data)
      } 
      else {
        console.error('Schema validation error', ajv.errors)
        noty({
          text: 'Schema validation error. Please check the console for errors.',
          type:'error',
          timeout: 1000
        })
      }
    },

    /**
     * Saves the properties of the interactive to the database.
     */
    async saveInteractive() {
      if (!this.valid) {
        noty({
          text: `Cant save since the schema is not valid.`,
          type:'error',
          timeout: 1000
        })
        return
      }
      this.state.saving = true
      try {
        this.interactive = new Interactive(await putInteractive({ data: this.interactive.toJSON() }))
        this.treema.set('/', $.extend(true, {}, this.interactive.attributes))
        noty({ text: 'Saved', type: 'success', timeout: 1000 })
      } catch (e) {
        console.error("Error while saving the interactive", e)
        noty({ text: 'Error occured while saving the interactive', type: 'error', timeout: 1000 })
      }
      this.state.saving = false
    },

    /**
     * Creates a new interactive in the database.
     */
    async createInteractive() {
      const name = window.prompt("Name of new interactive?")
      if (!name) { return }
      try {
        const result = await postInteractive({ name })
        return this.fetchList()
      } catch(e) {
        console.error("Error:", e)
        noty({ text: 'An error occurred', type: 'error', timeout: 1000 })
      }
    }

  },
  computed: {
    heading: function() {
      if (this.interactiveSlug && this.interactive) {
        return `Interactive Editor: '${this.interactive.get('name')}'`
      }
      return "Interactive Editor"
    }
  }
})
</script>

<template>
  <div class="container">

    <div v-if='!interactiveSlug'>
      <div class="row">
        <div class="col-md-12"><h1>{{ heading }}</h1></div>
      </div>
      <div class="row">
        <ul>
          <list-item
            v-for="int in interactiveList"
            :key="int.slug"
            :text="int.name"
            :slug="int.slug"
            :clickHandler="() => fetchInteractive(int.slug)"
            ></list-item>
            <li><button @click="createInteractive">+</button></li>
        </ul>
      </div>
    </div>

    <div v-else>
      <div class="row">
        <div class="col-md-8"><h1>{{ heading }}</h1></div>
        <div class="col-md-4">
          <span>There is no autosave. Please click this button often.</span>
          <button @click="saveInteractive" :disabled="state.saving || !interactive">save</button>
          <button><a @click="fetchList()">Back to list view</a></button>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <p style="padding-top:20px">NOTE: Please save the data for interactives before adding the solution.</p>
          <div id="treema-editor" ref="treemaEditor"></div>
        </div>
      </div>
    </div>

  </div>
</template>

<style scoped>
  .container {
    margin-top: 30px;
    background-color: white;
    padding: 20px;
  }
  button {
    margin: 5px;
    padding: 5px;
  }
</style>
